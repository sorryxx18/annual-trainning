<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ä¸­éšŠå¸¸è¨“å¡«å ±ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        // ==========================================
        // âš ï¸ã€Google Apps Script ç¶²å€ã€‘
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzxOYGbo4WnSJcSNkFu20J07VyE_K7vyWo3QFfXvx_pHW-vPFwOapapF0j-cISz2YnP/exec"; 
        // ==========================================

        // å–®ä½æ¸…å–®å®šç¾©
        const UNITS = {
            "ç¬¬ä¸€å¤§éšŠ":["ä¸­æ­£ä¸­éšŠ", "è¬è¯ä¸­éšŠ", "æ–‡å±±ä¸­éšŠ"],
            "ç¬¬äºŒå¤§éšŠ":["å¤§å®‰ä¸­éšŠ", "ä¿¡ç¾©ä¸­éšŠ", "å—æ¸¯ä¸­éšŠ"],
            "ç¬¬ä¸‰å¤§éšŠ":["ä¸­å±±ä¸­éšŠ", "æ¾å±±ä¸­éšŠ", "å…§æ¹–ä¸­éšŠ"],
            "ç¬¬å››å¤§éšŠ":["å¤§åŒä¸­éšŠ", "å£«æ—ä¸­éšŠ", "åŒ—æŠ•ä¸­éšŠ"]
        };

        // æ’åºç”¨æ¬Šé‡ (å…ˆä¾å–®ä½æ’åº)
        const UNIT_ORDER =[
            "ç¬¬ä¸€å¤§éšŠ", "ç¬¬äºŒå¤§éšŠ", "ç¬¬ä¸‰å¤§éšŠ", "ç¬¬å››å¤§éšŠ",
            "ä¸­æ­£ä¸­éšŠ", "è¬è¯ä¸­éšŠ", "æ–‡å±±ä¸­éšŠ",
            "å¤§å®‰ä¸­éšŠ", "ä¿¡ç¾©ä¸­éšŠ", "å—æ¸¯ä¸­éšŠ",
            "ä¸­å±±ä¸­éšŠ", "æ¾å±±ä¸­éšŠ", "å…§æ¹–ä¸­éšŠ",
            "å¤§åŒä¸­éšŠ", "å£«æ—ä¸­éšŠ", "åŒ—æŠ•ä¸­éšŠ"
        ];

        // å›ºå®šçš„ç¯„ä¾‹è³‡æ–™
        const MOCK_EXAMPLES =[
            { isExample: true, level: "å¤§éšŠå¸¸è¨“", period: "114å¹´ä¸ŠåŠå¹´", unit: "ç¬¬ä¸€å¤§éšŠ", dates: "114å¹´2æœˆ10æ—¥ã€15æ—¥", courses: "å¾Œå‹¤ç…§è­·ã€æ–°å¼é«”èƒ½æ¸¬é©—", people: "327", createdAt: "ç³»çµ±ç¯„ä¾‹" },
            { isExample: true, level: "ä¸­éšŠå¸¸è¨“", period: "114å¹´1æœˆ", unit: "ä¸­æ­£ä¸­éšŠ", dates: "114å¹´1æœˆ5æ—¥ã€10æ—¥", courses: "ç ´é–€è¨“ç·´ã€ç«å ´æœæ•‘æ¼”ç·´", people: "63", createdAt: "ç³»çµ±ç¯„ä¾‹" }
        ];
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        
        aside { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }
        @media (min-width: 768px) { .sidebar-closed { transform: translateX(0); } }

        .sidebar-link { cursor: pointer; transition: all 0.2s; }
        .sidebar-link.active { background: rgba(37, 99, 235, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        .sidebar-link:hover:not(.active) { background: #1e293b; color: white; }
        
        .table-wrapper { width: 100%; overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; min-width: 1050px; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8fafc; color: #475569; font-weight: 700; padding: 12px 10px; border: 1px solid #cbd5e1; font-size: 14px; position: sticky; top: 0; }
        td { border: 1px solid #cbd5e1; padding: 10px 8px; vertical-align: middle; background: white; font-size: 14px; }
        
        .example-row td { background-color: #fefce8 !important; color: #854d0e; border-style: dashed; }
        
        .input-style { width: 100%; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px 12px; font-size: 14px; outline: none; transition: all 0.2s; background: #f8fafc; }
        .input-style:focus { border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-style:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
        
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; font-size: 14px; cursor: pointer; }
        .btn-blue { background: #2563eb; color: white; } .btn-blue:hover { background: #1d4ed8; }
        .btn-white { background: white; border: 1px solid #cbd5e1; color: #475569; } .btn-white:hover { background: #f8fafc; border-color: #94a3b8; color: #2563eb; }
        .btn-red { background: #ef4444; color: white; } .btn-red:hover { background: #dc2626; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .day-cell { padding: 8px; text-align: center; border-radius: 6px; cursor: pointer; border: 1px solid #e2e8f0; font-size: 14px; background: white; }
        .day-cell.selected { background: #3b82f6; color: white; font-weight: bold; }
        .day-cell.weekend { color: #ef4444; }
        
        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fca5a5; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex overflow-hidden">
    <!-- è¼‰å…¥å‹•ç•« -->
    <div id="loading"><div class="spinner mb-4"></div><div class="font-bold text-lg ml-3" id="loadingText">è™•ç†ä¸­...</div></div>

    <!-- å´é‚Šæ¬„ -->
    <aside id="mainSidebar" class="w-64 bg-slate-900 text-white flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 shadow-2xl md:flex shrink-0">
        <div class="p-6 border-b border-slate-800 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg"><i class="ri-shield-user-fill text-xl"></i></div>
                <div><h1 class="font-bold text-lg tracking-wide">å¸¸è¨“å¡«å ±</h1><p class="text-[11px] text-slate-400">å¤§ä¸­éšŠè¨“ç·´ç®¡ç†ç³»çµ±</p></div>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i class="ri-close-line text-2xl"></i></button>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div onclick="switchPage('input')" id="nav-input" class="sidebar-link active px-4 py-3 rounded-xl flex items-center gap-3"><i class="ri-edit-box-line text-xl"></i> æ–°å¢å¡«å ±</div>
            <div onclick="switchPage('history')" id="nav-history" class="sidebar-link px-4 py-3 rounded-xl flex items-center gap-3"><i class="ri-history-line text-xl"></i> æ­·å²ç´€éŒ„</div>
        </nav>
    </aside>

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative min-w-0">
        <!-- æ‰‹æ©Ÿç‰ˆé ‚éƒ¨å°è¦½ -->
        <header class="bg-white border-b border-slate-200 h-14 flex items-center justify-between px-4 md:hidden shrink-0 z-10">
            <div class="font-bold text-slate-700 flex items-center gap-2">
                <span class="w-6 h-6 bg-blue-600 rounded flex items-center justify-center text-white text-sm"><i class="ri-shield-user-fill"></i></span>
                å¸¸è¨“å¡«å ±ç³»çµ±
            </div>
            <button onclick="toggleSidebar()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg"><i class="ri-menu-line text-xl"></i></button>
        </header>

        <!-- 114å¹´åº¦ ç¨½æ ¸æé†’æ©«å¹… -->
        <div id="alertBanner" class="bg-rose-50 border-b border-rose-200 px-6 py-4 flex items-start gap-3 hidden shadow-sm shrink-0">
            <div class="mt-1 bg-rose-100 p-1.5 rounded-full"><i class="ri-file-search-fill text-rose-500 text-lg"></i></div>
            <div class="flex-1 min-w-0">
                <h3 class="font-bold text-rose-800 text-sm mb-2 flex items-center gap-2">
                    <span id="alertTitle">114å¹´åº¦ å¸¸è¨“èª¿æŸ¥é€²åº¦</span>
                    <button onclick="loadHistory(true)" class="text-[10px] bg-white border border-rose-200 px-2 py-0.5 rounded hover:bg-rose-50 text-rose-600"><i class="ri-refresh-line"></i> é‡æ–°åŒæ­¥</button>
                </h3>
                <div class="text-[13px] text-rose-700 leading-relaxed font-medium max-h-32 overflow-y-auto custom-scrollbar pr-2" id="alertContent">è¼‰å…¥ä¸­...</div>
            </div>
            <button onclick="$('#alertBanner').classList.add('hidden')" class="text-rose-400 hover:text-rose-700"><i class="ri-close-line text-lg"></i></button>
        </div>

        <!-- å¡«å ±é é¢ -->
        <div id="page-input" class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-800 px-6 py-4 flex items-center gap-3">
                    <i class="ri-survey-line text-2xl text-blue-400"></i>
                    <h2 class="text-lg font-bold text-white">å¸¸è¨“è¾¦ç†æƒ…å½¢å¡«å ±</h2>
                </div>
                
                <div class="p-6 md:p-8 space-y-6">
                    <!-- 1. è¨“ç·´å±¤ç´š -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">1. è¨“ç·´å±¤ç´š</label>
                        <div class="flex gap-4">
                            <label class="flex-1 border border-slate-200 rounded-lg p-3 cursor-pointer hover:bg-slate-50 flex items-center gap-3 transition">
                                <input type="radio" name="trainLevel" value="å¤§éšŠå¸¸è¨“" onchange="updateFormUI()" checked class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                <span class="font-bold text-slate-700">å¤§éšŠå¸¸è¨“</span>
                            </label>
                            <label class="flex-1 border border-slate-200 rounded-lg p-3 cursor-pointer hover:bg-slate-50 flex items-center gap-3 transition">
                                <input type="radio" name="trainLevel" value="ä¸­éšŠå¸¸è¨“" onchange="updateFormUI()" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                <span class="font-bold text-slate-700">ä¸­éšŠå¸¸è¨“</span>
                            </label>
                        </div>
                    </div>

                    <hr class="border-slate-100">

                    <!-- 2. å–®ä½é¸æ“‡ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">2-1. æ‰€å±¬å¤§éšŠ</label>
                            <select id="selBattalion" onchange="updateCompanyDropdown()" class="input-style font-bold">
                                <option value="">è«‹é¸æ“‡å¤§éšŠ...</option>
                                <option value="ç¬¬ä¸€å¤§éšŠ">ç¬¬ä¸€å¤§éšŠ</option>
                                <option value="ç¬¬äºŒå¤§éšŠ">ç¬¬äºŒå¤§éšŠ</option>
                                <option value="ç¬¬ä¸‰å¤§éšŠ">ç¬¬ä¸‰å¤§éšŠ</option>
                                <option value="ç¬¬å››å¤§éšŠ">ç¬¬å››å¤§éšŠ</option>
                            </select>
                        </div>
                        <div id="companyContainer" class="hidden">
                            <label class="block text-sm font-bold text-slate-700 mb-2">2-2. å¡«å ±ä¸­éšŠ</label>
                            <select id="selCompany" class="input-style font-bold">
                                <option value="">è«‹å…ˆé¸æ“‡å¤§éšŠ...</option>
                            </select>
                        </div>
                    </div>

                    <!-- 3. æœŸåˆ¥èˆ‡æ—¥æœŸ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">3-1. è¾¦ç†å¹´åº¦</label>
                            <select id="selYear" class="input-style">
                                <option value="114å¹´" selected>114å¹´</option>
                                <option value="115å¹´">115å¹´</option>
                                <option value="116å¹´">116å¹´</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2" id="periodLabel">3-2. æœŸåˆ¥</label>
                            <select id="selPeriod" class="input-style"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">3-3. è¨“ç·´æ—¥æœŸ</label>
                            <div class="relative">
                                <input type="text" id="trainDates" readonly placeholder="é»æ“Šé¸å–æ—¥æœŸ(å¯å¤šé¸)" class="input-style cursor-pointer bg-white" onclick="openCalendar()">
                                <i class="ri-calendar-2-line absolute right-3 top-2.5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <hr class="border-slate-100">

                    <!-- 4. èª²ç¨‹å…§å®¹ -->
                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <label class="block text-sm font-bold text-slate-700">4. èª²ç¨‹å…§å®¹ <span class="text-xs text-rose-500 font-normal ml-1">(æœ€å°‘2é …ï¼Œæœ€å¤š4é …)</span></label>
                            <button type="button" onclick="addCourse()" id="btnAddCourse" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded hover:bg-blue-100 flex items-center gap-1 transition">
                                <i class="ri-add-line"></i> æ–°å¢ä¸€é …èª²ç¨‹
                            </button>
                        </div>
                        <div id="courseContainer" class="space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <!-- JS å‹•æ…‹å¡«å…¥ -->
                        </div>
                    </div>

                    <!-- 5. è¨“ç·´äººæ¬¡ -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">5. ç¸½åƒèˆ‡äººæ¬¡</label>
                        <div class="relative w-48">
                            <input type="number" id="trainPeople" min="0" placeholder="0" class="input-style pr-8 text-lg font-bold text-blue-700">
                            <span class="absolute right-3 top-2 text-slate-500 font-bold">äºº</span>
                        </div>
                    </div>

                    <!-- é€å‡ºæŒ‰éˆ• -->
                    <div class="pt-4 flex justify-end gap-3 border-t border-slate-100">
                        <button type="button" onclick="resetForm()" class="btn btn-white"><i class="ri-refresh-line"></i> é‡æ–°å¡«å¯«</button>
                        <button type="button" onclick="submitData()" class="btn btn-blue px-8 shadow-lg shadow-blue-200 text-base"><i class="ri-send-plane-fill"></i> ç¢ºèªé€å‡º</button>
                    </div>
                </div>
            </div>
            <div class="h-10"></div>
        </div>

        <!-- æ­·å²ç´€éŒ„é é¢ -->
        <div id="page-history" class="hidden flex-1 flex-col p-6 overflow-hidden h-full">
            <div class="flex justify-between items-center mb-4 shrink-0 flex-wrap gap-2">
                <div class="flex items-center gap-2">
                    <span class="w-1.5 h-6 bg-emerald-500 rounded-full"></span>
                    <h2 class="text-xl font-bold text-slate-800">æ­·å²ç´€éŒ„è³‡æ–™åº«</h2>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-white" onclick="loadHistory(true)"><i class="ri-refresh-line"></i> é‡æ–°æ•´ç†</button>
                    <button class="btn btn-white" onclick="exportExcel()"><i class="ri-file-excel-2-line text-emerald-600"></i> åŒ¯å‡º Excel</button>
                </div>
            </div>
            
            <div class="table-wrapper flex-1 min-h-0 overflow-auto border border-slate-200 shadow-sm relative">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th style="width:60px">é …æ¬¡</th>
                            <th style="width:110px">è¨“ç·´å±¤ç´š</th>
                            <th style="width:120px">å¡«å ±å–®ä½</th>
                            <th style="width:120px">å¹´åº¦/æœŸåˆ¥</th>
                            <th style="width:180px">è¨“ç·´æ—¥æœŸ</th>
                            <th style="width:250px">èª²ç¨‹å…§å®¹</th>
                            <th style="width:80px" class="text-right">äººæ¬¡</th>
                            <th style="width:150px">å»ºç«‹æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- è³‡æ–™ç”± JS æ¸²æŸ“ -->
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é åˆ— -->
            <div class="h-[60px] flex items-center justify-between border-t border-slate-200 pt-3 mt-2 shrink-0 bg-slate-50 rounded-b-xl px-2">
                <div class="text-sm text-slate-500">é¡¯ç¤ºç¬¬ <span id="pageStart" class="font-bold">0</span> - <span id="pageEnd" class="font-bold">0</span> ç­†ï¼Œå…± <span id="pageTotal" class="font-bold text-slate-700">0</span> ç­†ç´€éŒ„</div>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" id="btnPrev" class="px-3 py-1.5 border border-slate-300 rounded bg-white hover:bg-slate-50 text-sm font-bold disabled:opacity-50">ä¸Šä¸€é </button>
                    <button onclick="changePage(1)" id="btnNext" class="px-3 py-1.5 border border-slate-300 rounded bg-white hover:bg-slate-50 text-sm font-bold disabled:opacity-50">ä¸‹ä¸€é </button>
                </div>
            </div>
        </div>
    </main>

    <!-- æ™ºæ…§è¬å¹´æ›† Modal -->
    <div id="calendarModal" class="fixed inset-0 bg-black/50 hidden z-[1000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[340px] p-5 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-3">
                <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><i class="ri-arrow-left-s-line text-xl"></i></button>
                <div class="font-bold text-lg text-slate-800" id="calMonthTitle">2026å¹´ 1æœˆ</div>
                <button onclick="changeMonth(1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><i class="ri-arrow-right-s-line text-xl"></i></button>
            </div>
            <div class="flex gap-2 mb-3 text-xs">
                <button onclick="calFilter('all')" class="flex-1 py-1.5 border border-slate-200 rounded hover:bg-slate-50 font-bold text-slate-600">å…¨é¸</button>
                <button onclick="calFilter('noWeekend')" class="flex-1 py-1.5 border border-slate-200 rounded hover:bg-slate-50 font-bold text-slate-600">å¹³æ—¥</button>
                <button onclick="calClear()" class="px-3 py-1.5 border border-red-200 text-red-500 rounded hover:bg-red-50 font-bold">æ¸…é™¤</button>
            </div>
            <div class="calendar-grid text-xs font-bold text-slate-400 mb-1">
                <div class="text-red-400">æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div class="text-red-400">å…­</div>
            </div>
            <div id="calGrid" class="calendar-grid"></div>
            <div class="mt-5 flex justify-end gap-2">
                <button onclick="closeCalendar()" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="confirmCalendar()" class="px-5 py-2 text-sm font-bold bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- é‚è¼¯è…³æœ¬ -->
    <script>
        const $ = (s) => document.querySelector(s);
        let courseCount = 0;
        let historyData = [...MOCK_EXAMPLES]; 
        
        // åˆ†é è®Šæ•¸
        let currentPage = 1;
        const itemsPerPage = 15;

        // æ—¥æ›†è®Šæ•¸
        let selectedDates = new Set(); 
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;

        // ç¶²é é–‹å•Ÿå³è‡ªå‹•è¼‰å…¥
        window.onload = () => {
            initForm();
            loadHistory(true); 
        };

        function toggleSidebar() {
            const sidebar = $('#mainSidebar');
            const overlay = $('#sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function switchPage(page) {
            if(window.innerWidth < 768) toggleSidebar();
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            $(`#nav-${page}`).classList.add('active');
            
            $('#page-input').classList.add('hidden');
            $('#page-history').classList.add('hidden');
            $('#page-history').classList.remove('flex');
            
            const target = $(`#page-${page}`);
            target.classList.remove('hidden');
            if(page === 'history') target.classList.add('flex');
        }

        // ==========================================
        // ğŸ“ è¡¨å–®é‚è¼¯
        // ==========================================
        function initForm() {
            $('#selYear').value = `114å¹´`; 
            updateFormUI();
            resetCourses();
        }

        function updateFormUI() {
            const level = $('input[name="trainLevel"]:checked').value;
            const selPeriod = $('#selPeriod');
            const containerCompany = $('#companyContainer');
            
            selPeriod.innerHTML = '';
            
            if (level === 'å¤§éšŠå¸¸è¨“') {
                $('#periodLabel').innerText = '3-2. è¾¦ç†æœŸåˆ¥';
                selPeriod.add(new Option('ä¸ŠåŠå¹´', 'ä¸ŠåŠå¹´'));
                selPeriod.add(new Option('ä¸‹åŠå¹´', 'ä¸‹åŠå¹´'));
                containerCompany.classList.add('hidden'); 
            } else {
                $('#periodLabel').innerText = '3-2. è¾¦ç†æœˆä»½';
                for(let i=1; i<=12; i++) selPeriod.add(new Option(`${i}æœˆ`, `${i}æœˆ`));
                selPeriod.value = `${new Date().getMonth() + 1}æœˆ`;
                containerCompany.classList.remove('hidden'); 
            }
            updateCompanyDropdown();
        }

        function updateCompanyDropdown() {
            const bat = $('#selBattalion').value;
            const selCompany = $('#selCompany');
            selCompany.innerHTML = '<option value="">è«‹é¸æ“‡ä¸­éšŠ...</option>';
            
            if (bat && UNITS[bat]) {
                selCompany.disabled = false;
                UNITS[bat].forEach(comp => {
                    selCompany.add(new Option(comp, comp));
                });
            } else {
                selCompany.disabled = true;
            }
        }

        function resetCourses() {
            $('#courseContainer').innerHTML = '';
            courseCount = 0;
            addCourse(); 
            addCourse(); 
            checkCourseButton();
        }

        function addCourse() {
            if (courseCount >= 4) return;
            courseCount++;
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 course-item';
            div.innerHTML = `
                <div class="bg-slate-200 text-slate-600 font-bold w-6 h-6 rounded flex items-center justify-center text-xs shrink-0">${courseCount}</div>
                <input type="text" class="input-style flex-1 course-input" placeholder="è«‹å¡«å¯«èª²ç¨‹åç¨±...">
                ${courseCount > 2 ? `<button onclick="removeCourse(this)" class="text-rose-400 hover:text-rose-600 p-2"><i class="ri-delete-bin-line text-lg"></i></button>` : '<div class="w-[34px]"></div>'}
            `;
            $('#courseContainer').appendChild(div);
            checkCourseButton();
        }

        function removeCourse(btn) {
            btn.closest('.course-item').remove();
            courseCount--;
            document.querySelectorAll('.course-item').forEach((el, index) => {
                el.querySelector('div').innerText = index + 1;
            });
            checkCourseButton();
        }

        function checkCourseButton() {
            const btnAdd = $('#btnAddCourse');
            if (courseCount >= 4) {
                btnAdd.classList.add('opacity-50', 'cursor-not-allowed');
                btnAdd.disabled = true;
            } else {
                btnAdd.classList.remove('opacity-50', 'cursor-not-allowed');
                btnAdd.disabled = false;
            }
        }

        function resetForm() {
            if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¡«å¯«è³‡æ–™å—ï¼Ÿ")) return;
            $('#selBattalion').value = '';
            $('#selCompany').value = '';
            $('#trainDates').value = '';
            $('#trainPeople').value = '';
            resetCourses();
            updateFormUI();
        }

        // ==========================================
        // ğŸ“… æ™ºæ…§æ—¥æ›†é‚è¼¯
        // ==========================================
        function openCalendar() {
            $('#calendarModal').classList.remove('hidden');
            $('#calendarModal').classList.add('flex');
            
            const selectedRocYear = parseInt($('#selYear').value.replace('å¹´',''));
            if (!isNaN(selectedRocYear)) {
                currentYear = selectedRocYear + 1911;
            }
            renderCalendar();
        }
        function closeCalendar() {
            $('#calendarModal').classList.add('hidden');
            $('#calendarModal').classList.remove('flex');
        }
        function renderCalendar() {
            const grid = $('#calGrid'); grid.innerHTML = '';
            $('#calMonthTitle').innerText = `${currentYear}å¹´ ${currentMonth}æœˆ`;
            const days = new Date(currentYear, currentMonth, 0).getDate();
            const first = new Date(currentYear, currentMonth - 1, 1).getDay();
            
            for(let i=0; i<first; i++) grid.innerHTML += `<div></div>`;
            
            for(let d=1; d<=days; d++) {
                const key = `${currentYear}/${currentMonth}/${d}`; 
                const w = new Date(currentYear, currentMonth-1, d).getDay(); 
                const isWk = (w===0||w===6);
                const isSel = selectedDates.has(key);
                
                const div = document.createElement('div');
                div.className = `day-cell ${isWk?'weekend':''} ${isSel?'selected':''}`; 
                div.innerText = d;
                div.onclick = () => { 
                    if(selectedDates.has(key)) selectedDates.delete(key); 
                    else selectedDates.add(key); 
                    renderCalendar(); 
                };
                grid.appendChild(div);
            }
        }
        function changeMonth(delta) { 
            currentMonth += delta; 
            if(currentMonth > 12) { currentMonth = 1; currentYear++; } 
            if(currentMonth < 1) { currentMonth = 12; currentYear--; } 
            renderCalendar(); 
        }
        function calFilter(type) {
            const days = new Date(currentYear, currentMonth, 0).getDate();
            for(let d=1; d<=days; d++) {
                const key = `${currentYear}/${currentMonth}/${d}`; 
                const w = new Date(currentYear, currentMonth-1, d).getDay(); 
                const isWk = (w===0||w===6);
                if (type === 'all') selectedDates.add(key);
                else if (type === 'noWeekend' && !isWk) selectedDates.add(key);
            } 
            renderCalendar();
        }
        function calClear() { selectedDates.clear(); renderCalendar(); }
        function confirmCalendar() {
            const sorted = Array.from(selectedDates).map(s => {
                const[y,m,d] = s.split('/').map(Number); 
                return {y, m, d};
            }).sort((a,b) => (a.y*10000 + a.m*100 + a.d) - (b.y*10000 + b.m*100 + b.d));
            
            if(sorted.length === 0) {
                $('#trainDates').value = "";
                closeCalendar(); return;
            }

            let groups = {}; 
            sorted.forEach(o => { 
                const k = `${o.y}-${o.m}`; 
                if(!groups[k]) groups[k] = []; 
                groups[k].push(o.d); 
            });
            
            let parts =[]; 
            for(let k in groups) { 
                const[y, m] = k.split('-').map(Number); 
                parts.push(`${y-1911}å¹´${m}æœˆ${groups[k].join('ã€')}æ—¥`); 
            }
            
            $('#trainDates').value = parts.join('ï¼› '); 
            closeCalendar();
        }

        // ==========================================
        // ğŸ’¾ è³‡æ–™é€å‡ºèˆ‡æ’åº
        // ==========================================
        function sortHistoryData() {
            historyData.sort((a, b) => {
                if(a.isExample && !b.isExample) return -1;
                if(!a.isExample && b.isExample) return 1;

                let idxA = UNIT_ORDER.indexOf(a.unit);
                let idxB = UNIT_ORDER.indexOf(b.unit);
                if (idxA === -1) idxA = 999;
                if (idxB === -1) idxB = 999;
                if (idxA !== idxB) return idxA - idxB;

                const parsePeriod = (periodStr) => {
                    let match = periodStr.match(/(\d+)å¹´(.*)/);
                    if (!match) return 0;
                    let y = parseInt(match[1]) * 100;
                    let mStr = match[2];
                    let m = 0;
                    if (mStr === 'ä¸ŠåŠå¹´') m = 1;
                    else if (mStr === 'ä¸‹åŠå¹´') m = 7;
                    else m = parseInt(mStr.replace('æœˆ', '')) || 0;
                    return y + m;
                };
                return parsePeriod(a.period) - parsePeriod(b.period);
            });
        }

        function submitData() {
            const level = $('input[name="trainLevel"]:checked').value;
            const bat = $('#selBattalion').value;
            const comp = $('#selCompany').value;
            const year = $('#selYear').value;
            const period = $('#selPeriod').value;
            const dates = $('#trainDates').value;
            const people = $('#trainPeople').value;
            
            if(!bat) return alert("è«‹é¸æ“‡å¤§éšŠï¼");
            if(level === 'ä¸­éšŠå¸¸è¨“' && !comp) return alert("è«‹é¸æ“‡ä¸­éšŠï¼");
            if(!dates) return alert("è«‹é¸å–è¨“ç·´æ—¥æœŸï¼");
            
            // æŠ“å–èª²ç¨‹å…§å®¹
            const coursesInputs = document.querySelectorAll('.course-input');
            let courses =[];
            coursesInputs.forEach(input => { 
                const val = input.value.trim();
                if(val) courses.push(val); 
            });
            
            if(courses.length < 2) return alert("è‡³å°‘éœ€è¦å¡«å¯« 2 é …èª²ç¨‹å…§å®¹ï¼");
            if(!people || parseInt(people) <= 0) return alert("è«‹å¡«å¯«æ­£ç¢ºçš„åƒèˆ‡äººæ¬¡ï¼");

            const finalUnit = level === 'å¤§éšŠå¸¸è¨“' ? bat : comp;

            const payload = {
                mode: 'append',
                data:[{
                    level: level,
                    year: year,
                    period: period,
                    unit: finalUnit,
                    dates: dates,
                    courses: courses.join('ã€'), 
                    people: people
                }]
            };

            $('#loadingText').innerText = "è³‡æ–™é€å‡ºä¸­...";
            $('#loading').style.display = 'flex';
            
            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'text/plain' }
            }).then(res => res.json()).then(json => {
                if(json.status === 'success') {
                    alert('å¡«å ±æˆåŠŸï¼');
                    resetForm();
                    loadHistory(false); // é€å‡ºæˆåŠŸå¾Œè‡ªå‹•åˆ·æ–°è³‡æ–™åº«
                } else {
                    alert('ç™¼ç”ŸéŒ¯èª¤: ' + json.message);
                }
            }).catch(e => {
                console.error(e);
                alert('ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }).finally(() => {
                $('#loading').style.display = 'none';
            });
        }

        // ==========================================
        // ğŸ“Š æ­·å²è³‡æ–™èˆ‡ç¨½æ ¸åŠŸèƒ½
        // ==========================================
        function loadHistory(showLoadingIcon = false) {
            if(showLoadingIcon) {
                $('#loadingText').innerText = "è³‡æ–™åŒæ­¥ä¸­...";
                $('#loading').style.display = 'flex';
            }

            // åŠ ä¸Š t åƒæ•¸ç ´è§£ç€è¦½å™¨å¿«å–
            fetch(GAS_API_URL + "?mode=get&t=" + new Date().getTime())
            .then(res => res.json())
            .then(json => {
                if(json.status === 'success') {
                    historyData = [...MOCK_EXAMPLES, ...(json.data ||[])];
                    sortHistoryData(); 
                    renderHistory();
                    checkAudit(); 
                }
            }).catch(err => console.error(err))
            .finally(() => {
                $('#loading').style.display = 'none';
            });
        }

        function renderHistory() {
            const tbody = $('#historyBody'); 
            tbody.innerHTML = '';
            
            const total = historyData.length;
            const maxPage = Math.ceil(total / itemsPerPage) || 1;
            
            if(currentPage > maxPage) currentPage = maxPage;
            if(currentPage < 1) currentPage = 1;

            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageData = historyData.slice(startIdx, endIdx);

            if(total === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-slate-400 py-10"><i class="ri-folder-open-line text-2xl mb-2 block"></i>ç›®å‰å°šç„¡ç´€éŒ„</td></tr>`;
            } else {
                pageData.forEach((row, i) => {
                    const globalIdx = startIdx + i + 1;
                    const tr = document.createElement('tr');
                    
                    tr.className = row.isExample ? 'example-row' : (i % 2 === 0 ? 'bg-white hover:bg-slate-50' : 'bg-slate-50 hover:bg-slate-100');
                    
                    const levelTag = row.level === 'å¤§éšŠå¸¸è¨“' 
                        ? `<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold border border-blue-200">å¤§éšŠ</span>`
                        : `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-xs font-bold border border-emerald-200">ä¸­éšŠ</span>`;

                    const exampleBadge = row.isExample ? `<span class="bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded text-[10px] ml-1 font-bold border border-amber-200">ç¯„ä¾‹</span>` : '';

                    tr.innerHTML = `
                        <td class="text-center text-slate-400 font-mono text-xs">${globalIdx}</td>
                        <td class="text-center">${levelTag}</td>
                        <td class="font-bold text-slate-700 flex items-center justify-center h-full gap-1 pt-[10px]">${row.unit} ${exampleBadge}</td>
                        <td class="font-bold text-slate-700">${row.period}</td>
                        <td class="text-slate-600 text-sm">${row.dates}</td>
                        <td class="text-slate-600 text-sm truncate max-w-[250px]" title="${row.courses}">${row.courses}</td>
                        <td class="text-right font-bold text-blue-600">${row.people}</td>
                        <td class="text-slate-400 text-xs">${row.createdAt}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            $('#pageStart').innerText = total > 0 ? startIdx + 1 : 0;
            $('#pageEnd').innerText = Math.min(endIdx, total);
            $('#pageTotal').innerText = total;
            
            $('#btnPrev').disabled = currentPage === 1;
            $('#btnNext').disabled = currentPage === maxPage || total === 0;
        }

        function changePage(delta) {
            currentPage += delta;
            renderHistory();
        }

        function exportExcel() {
            const exportData = historyData.filter(r => !r.isExample);
            if(exportData.length === 0) return alert('ç›®å‰åªæœ‰ç¯„ä¾‹ï¼Œç„¡å¯¦éš›è³‡æ–™å¯åŒ¯å‡ºï¼');
            
            const wb = new ExcelJS.Workbook(); 
            const ws = wb.addWorksheet('å¸¸è¨“ç´€éŒ„è¡¨');
            
            ws.columns =[
                {header:'é …æ¬¡', key:'id', width:8},
                {header:'è¨“ç·´å±¤ç´š', key:'level', width:15},
                {header:'å¡«å ±å–®ä½', key:'unit', width:15},
                {header:'å¹´åº¦/æœŸåˆ¥', key:'period', width:15},
                {header:'è¨“ç·´æ—¥æœŸ', key:'dates', width:35},
                {header:'èª²ç¨‹å…§å®¹', key:'courses', width:50},
                {header:'åƒèˆ‡äººæ¬¡', key:'people', width:12},
                {header:'å»ºç«‹æ™‚é–“', key:'createdAt', width:20}
            ];
            
            ws.getRow(1).eachCell(c => {
                c.font = {bold: true, color: {argb: 'FFFFFFFF'}};
                c.fill = {type: 'pattern', pattern: 'solid', fgColor: {argb: 'FF1E293B'}};
                c.alignment = {vertical: 'middle', horizontal: 'center'};
            });

            exportData.forEach((r, i) => { 
                ws.addRow({...r, id: i+1}); 
            });

            wb.xlsx.writeBuffer().then(buf => {
                saveAs(new Blob([buf]), 'å¸¸è¨“ç´€éŒ„çµ±è¨ˆè¡¨.xlsx');
            });
        }

        // ==========================================
        // âš ï¸ æ™ºæ…§ç¨½æ ¸ (å®Œå…¨ä¿®å¾©é‚è¼¯æ¼æ´)
        // ==========================================
        function checkAudit() {
            const TARGET_YEAR = '114å¹´';
            
            const reportedBats = {}; 
            const reportedComps = {}; 

            // â˜… ä¿®æ­£ 1ï¼šå¿…é ˆå…ˆåˆå§‹åŒ–å¤§éšŠçš„æª¢æŸ¥æ¸…å–®ï¼å¦å‰‡ç¨½æ ¸æœƒè·³éå®ƒã€‚
            ["ç¬¬ä¸€å¤§éšŠ", "ç¬¬äºŒå¤§éšŠ", "ç¬¬ä¸‰å¤§éšŠ", "ç¬¬å››å¤§éšŠ"].forEach(b => {
                reportedBats[b] = new Set();
            });

            for (let b in UNITS) {
                UNITS[b].forEach(c => reportedComps[c] = new Set());
            }

            // æƒææ­·å²è³‡æ–™
            historyData.forEach(row => {
                if(row.isExample) return; 

                const unitName = String(row.unit).trim();
                const periodName = String(row.period).trim();

                const match = periodName.match(/(\d+å¹´)(.*)/);
                if(match && match[1] === TARGET_YEAR) {
                    const monthOrHalf = match[2].trim(); 
                    
                    // â˜… ä¿®æ­£ 2ï¼šç¢ºä¿æ‰¾åˆ°äº†å°æ‡‰çš„å–®ä½æ‰é€²è¡Œæ¨™è¨˜
                    if(row.level === 'å¤§éšŠå¸¸è¨“' && reportedBats[unitName] !== undefined) {
                        reportedBats[unitName].add(monthOrHalf);
                    }
                    if(row.level === 'ä¸­éšŠå¸¸è¨“' && reportedComps[unitName] !== undefined) {
                        reportedComps[unitName].add(monthOrHalf);
                    }
                }
            });

            let missingAlerts =[];

            // 1. æª¢æŸ¥å¤§éšŠå¸¸è¨“
            let batMissingMsg =[];["ç¬¬ä¸€å¤§éšŠ","ç¬¬äºŒå¤§éšŠ","ç¬¬ä¸‰å¤§éšŠ","ç¬¬å››å¤§éšŠ"].forEach(b => {
                let missing = [];
                const repSet = reportedBats[b];
                
                if(!repSet.has('ä¸ŠåŠå¹´')) missing.push('ä¸ŠåŠå¹´');
                if(!repSet.has('ä¸‹åŠå¹´')) missing.push('ä¸‹åŠå¹´');
                
                if(missing.length > 0) {
                    batMissingMsg.push(`[${b}] ç¼ºäº¤ï¼š${missing.join('ã€')}`);
                }
            });
            if(batMissingMsg.length > 0) {
                missingAlerts.push(`<div class="mb-1.5"><span class="bg-rose-200 text-rose-800 px-1.5 py-0.5 rounded text-[11px] font-bold mr-1">å¤§éšŠ</span> ${batMissingMsg.join(' ï¼› ')}</div>`);
            }

            // 2. æª¢æŸ¥ä¸­éšŠå¸¸è¨“
            let compMissingMsg =[];
            for(let c in reportedComps) {
                let missing =[];
                for(let m=1; m<=12; m++) {
                    if(!reportedComps[c].has(`${m}æœˆ`)) missing.push(`${m}æœˆ`);
                }
                if(missing.length > 0) {
                    if(missing.length === 12) {
                        compMissingMsg.push(`[${c}] ç¼ºäº¤ï¼šå…¨å¹´åº¦`);
                    } else {
                        compMissingMsg.push(`[${c}] ç¼ºäº¤ï¼š${missing.join('ã€')}`);
                    }
                }
            }
            if(compMissingMsg.length > 0) {
                missingAlerts.push(`<div><span class="bg-rose-200 text-rose-800 px-1.5 py-0.5 rounded text-[11px] font-bold mr-1">ä¸­éšŠ</span> ${compMissingMsg.join(' ï¼› ')}</div>`);
            }

            // é¡¯ç¤ºæˆ–éš±è— Banner
            const banner = $('#alertBanner');
            if(missingAlerts.length > 0) {
                banner.classList.remove('hidden');
                $('#alertContent').innerHTML = missingAlerts.join('');
            } else {
                banner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
